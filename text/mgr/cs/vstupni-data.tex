\chapter{Zdrojová data}
\label{ch:zdrojova-data}

Zdrojová data pro vyhledávač pochází ze dvou zdrojů. Prvním zdrojem jsou mapová
data, která obsahují silnice, cesty, budovy a další mapové prvky. Druhým zdrojem
jsou data o~jízdních řádech, která obsahují linky, zastávky a spoje.

\section{Mapová data}
Mapová data jsou použita z~projektu OpenStreetMap \cite{OSM} (OSM). Tato data neobsahují
informace o~nadmořské výšce jednotlivých bodů; k~doplnění nadmořské výšky jsou
použita data z~projektu NASA Shuttle Radar Topography Mission (SRTM), která jsou
lineárně interpolována pro získání nadmořských výšek jednotlivých bodů v~mapě.

O~datech OSM a jejich problémech jsme již rozsáhle pojednávali v~bakalářské
práci \cite{bakalarka}, níže citujeme obecný úvod a popis základních primitiv. 
\newcommand{\tuc}{\bf}
\subsection{Projekt OpenStreetMap}
Projekt OpenStreetMap \cite{OSM} vznikl v~Anglii v~roce 2004 a jeho prvotním cílem bylo
vytvořit volně dostupná geografická data pro Velkou Británii. Iniciativa se
postupně rozrostla do celého světa a dnes mapu pomáhá tvořit přes milion
dobrovolníků. Česká republika je dnes poměrně kvalitně pokryta a zvláště velká
města mají dostatečně detailní pokrytí i pro vyhledávání pěších tras.

\subsection{Datová primitiva OSM} 
Projekt OpenStreetMap používá tři základní geografická primitiva: uzly, cesty a
relace. Ke každému z~těchto primitiv mohou být přiřazeny atributy, což jsou
dvojice klíče a hodnoty. Každý typ primitiv má svou číselnou řadu, ze které
dostává každý prvek unikátní číslo -- id. 
U~polohových dat se neukládá výška, výsledná mapa je pouze dvourozměrná.
Nyní popíšeme jednotlivá primitiva:

{\tuc Uzly} jsou body s~určenými souřadnicemi. Uzly mohou mít atributy, ty pak
určují bodový mapový objekt, například rozcestník nebo závoru. Existují i uzly
bez atributů sloužící pouze jako součást cest nebo relací.

{\tuc Cesty} jsou lomené čáry definované posloupností uzlů. Uzly se na cestě nemohou opakovat
s~jedinou výjimkou: první a poslední bod mohou být shodné, potom se jedná
o~uzavřenou cestu. Cesty jsou orientované, tzn. na pořadí uzlů záleží. Mohou
existovat cesty bez atributů jako součásti relace, ale obvykle mají atributy
určující, jaký objekt reálného světa popisují.

Pomocí cest popisujeme linie a plochy. Pokud má být cesta plochou, musí být
uzavřená, ale ne každá uzavřená cesta je plocha. Tento problém rozebíráme níže.
Jedna cesta také může reprezentovat více fyzických objektů (například silnici
s~tramvajovou tratí, park s~oplocením).

{\tuc Relace} jsou posloupnosti uzlů a cest opatřené atributy. Každý prvek
v~relaci navíc může mít určenou roli. Relace může obsahovat jako prvek i relaci,
ale tato situace není příliš dobře podporována programy pracujícími s~daty OSM. 
Obvykle jsou relacemi reprezentovány složitější objekty, které by se cestami a
uzly popisovaly obtížně, nebo také \uv{virtuální} objekty jako například
trasy linek MHD, cyklotrasy a územní hranice.

Pro nás důležitý typ relace je {\tuc multipolygon}, který se používá k~reprezentaci
složitějších ploch. Plocha reprezentovaná multipolygonem se může skládat z~více
nesouvisejících částí nebo obsahovat díry. Multipolygon obsahuje cesty s~rolemi 
\verb|INNER| resp. \verb|OUTER| indikující, zda je cesta součástí vnější resp.
vnitřní hranice plochy. Hranice multipolygonu se mohou skládat z~více částí, ale
vždy musí dohromady tvořit jednu nebo několik uzavřených částí tvořících obvody 
plochy resp. díry v~ploše.

\section{Výšková data}
O~výškových datech jsme také pojednávali v~bakalářské práci, opět
citujeme \cite{bakalarka}:
Abychom mohli správně odhadnout náročnost pěší trasy, musíme znát i informace
o~nadmořské výšce jednotlivých bodů. Stejně tak jako většina jiných projektů jsme
použili data SRTM \cite{SRTM}, což jsou volně dostupná výšková data pro celý
svět.

Shuttle Radar Topography Mission byl projekt NASA, kdy při letu raketoplánu
Endeavour v~roce 2000 byla pomocí radarové interferometrie změřena velká část
Země a zpracovaná data byla následně poskytnuta volně k~dispozici.\footnote{\url{http://dds.cr.usgs.gov/srtm/version2_1/}} 

Výšková data byla měřena po třech úhlových vteřinách (v~USA po jedné vteřině),
tudíž v~České republice jsou data v~mřížce $90\times60$\,m. Data jsou rozdělena
do tabulek po jednom stupni, přičemž sousední tabulky se vždy jedním sloupcem
nebo řádkem překrývají. Každá tabulka má tedy 1201 sloupců a 1201 řádků, kde
řádky odpovídají zeměpisné šířce a sloupce zeměpisné délce.

Nadmořské výšky jsou kódovány celými 16bitovými čísly v~big endian udávajícími
nadmořskou výšku v~metrech. Pokud se v~některém místě nepodařilo výšku změřit,
je udávána jako $-32768$. Tabulka je kódována jako binární soubor, v~němž jsou
jednotlivé řádky zapsány za sebou.

\section{Jízdní řády}
Data o~jízdních řádech jsou očekávána ve formátu General Transit Feed
Specification (GTFS) \cite{GTFS}, který je dobře specifikovaný a široce používaný ve světě.
Konkrétně pro testování byla použita data o~pražské integrované dopravě od IPR
Praha.\footnote{\url{http://opendata.iprpraha.cz/DPP/JR/jrdata.zip}} Tato data
obsahují metro, tramvaje, autobusy a přívozy v~Praze a okolí, bohužel neobsahují
integrované vlakové spoje.

GTFS je distribuováno jako archiv ZIP obsahující jednotlivé tabulky ve formátu
CSV. Význam jednotlivých tabulek je následující:
\begin{itemize}
\item {\em agency.txt} obsahuje informace o~dopravcích na jednotlivých linkách.
V~našem vyhledávání není používán.
\item {\em stops.txt} obsahuje informace o~zastávkách. Zastávky jsou dvou typů.
Prvním typem je zastávkový stojan, který reprezentuje fyzické místo, kde
zastavuje nějaký spoj některé linky. Druhým typem je \uv{stanice}, která udává
oblast několika stojanů, obvykle stejného jména. Nemusí mít fyzickou
reprezentaci a slouží pro zobrazování v~mapě a svázání logicky blízkých stojanů.
Protože stanice pro náš vyhledávač nenese důležitou informaci, využíváme pouze
zastávkové stojany. Pro vyhledávání spojení využíváme
následující položky:
\begin{itemize}
	\item {\tt stop\_id} -- jednoznačný identifikátor zastávky
	\item {\tt stop\_name} -- název zastávky
	\item {\tt stop\_lat, stop\_lon} -- poloha zastávky
	\item {\tt location\_type} -- informace, zda jde o~stojan, nebo stanici
\end{itemize}
\item {\em routes.txt} obsahuje informace o~linkovém vedení. Pro vyhledávání
spojení využíváme následující položky:
\begin{itemize}
	\item {\tt route\_id} -- jednoznačný identifikátor linky
	\item {\tt route\_short\_name} -- krátký název linky, v~Praze označení linky
	\item {\tt route\_type} -- typ dopravního prostředku linky, například autobus, loď, metro
\end{itemize}
\item {\em trips.txt} obsahuje informace o~spojích. Tato tabulka slouží ke
svázání spoje (cesty konkrétního dopravního prostředku po posloupnosti zastávek
v~daný čas), linky a množiny dní, kdy daný spoj jezdí. Pro vyhledávání využíváme
následující položky:
\begin{itemize}
	\item {\tt route\_id} -- identifikátor linky
	\item {\tt service\_id} -- identifikátor jízdních dní spoje
	\item {\tt trip\_id} -- jednoznačný identifikátor spoje
\end{itemize}
\item {\em stop\_times.txt} obsahuje informace o~časech zastavení jednotlivých
spojů v~jednotlivých zastávkách. Pro vyhledávání spojení používáme následující
položky:
\begin{itemize}
	\item {\tt trip\_id} -- identifikátor spoje
	\item {\tt arrival\_time} -- čas příjezdu spoje do zastávky 
	\item {\tt departure\_time} -- čas odjezdu spoje ze zastávky
	\item {\tt stop\_id} -- identifikátor zastávky
	\item {\tt stop\_sequence} -- pořadí zastávky na spoji. Je potřeba, aby
	bylo nezáporné, celočíselné a po trase spoje se zvyšovalo, zvyšování po
	1 ani počítání od 0 není nutné.
\end{itemize}
\item {\em calendar.txt} obsahuje informace o~tom, které dny v~týdnu jezdí které
spoje. Pro vyhledávání spojení používáme následující položky:
\begin{itemize}
	\item {\tt service\_id} -- identifikátor jízdních dní spoje
	\item {\tt monday \dots{} sunday} -- informace, zda spoj jede daný den. 
	\item {\tt start\_date} -- první den platnosti jízdního řádu pro daný
	spoj
	\item {\tt end\_date} -- poslední den platnosti jízdního řádu pro daný
	spoj (tento den ještě v~rámci platnosti).
\end{itemize}
\item {\em calendar\_dates.txt} obshauje výjimky z~pravidelnosti spojů,
například státní svátky či jiná omezení. Obsahuje změny oproti souboru {\tt
calendar.txt}. Může být použit i samostatně bez souboru {\tt
calendar.txt}, pak obsahuje všechny jízdní dny daného spoje. Pro vyhledávání
spojení používáme následující položky:
\begin{itemize}
	\item {\tt service\_id} -- identifikátor jízdních dní spoje 
	\item {\tt date} -- datum změny
	\item {\tt exception\_type} -- typ změny (1 = jede navíc, 2 = nejede, ač
	by měl)
\end{itemize}
\end{itemize}

\section{Používané formáty dat}

\subsection{Protocol Buffers}
Protocol Buffers (PBF) \cite{PBF} je způsob uložení strukturovaných dat. Byl navržen
Googlem a je používán v~případech, kdy potřebujeme přenést po síti zprávy
s~danou strukturou. Formát podporuje různé datové typy (integer různých přesností
a znaménkovosti, čísla s~plovoucí řádovou čárkou, řetězce znaků, \dots) a
strukturování zpráv. Komunikace probíhá ve fázích naplnění zprávy, její
zabalení, odeslání, přijmutí a rozbalení. Při zabalení jsou data zkomprimovaná
jednoduchým algoritmem, aby například malá čísla nezabírala zbytečně mnoho
místa. Existují PBF verze 2 a verze 3. V~naší práci používáme verzi 2, protože
v~době psaní bakalářské práce, kterou v~naší práci rozšiřujeme, nebyly PBF verze 3
ještě k~dispozici a verze 3 nepřináší novinky, které by motivovaly k~přechodu.

Základní jednotkou PBF je zpráva, která obsahuje několik položek. Položkou může
být základní datový typ nebo jiná zpráva, položky mohou být povinné, volitelné,
nebo opakované. Každá položka má jméno, typ a číslo, které ho identifikuje
v~binární podobě zprávy. Zprávy se popisují pomocí vlastního jazyka, ze kterého se
pak pomocí kompilátoru vytvoří vazby do jednotlivých programovacích jazyků. 
Podrobnou dokumentaci včetně tutoriálů lze najít na stránkách projektu. \cite{PBF}

\subsection{JavaScript Object Notation}
JavaScript Object Notation \cite{JSON} (JSON) je formát navržený pro předávání dat ve
webových aplikacích. Díky své jednoduchosti a čitelné reprezentaci je hojně
využíván nejen ve webových projektech, ale často i jako konfigurační jazyk.
Vychází z~Javascriptu, datové typy v~něm jsou kromě primitivních typů slovník --
neuspořádaný seznam dvojic klíč-hodnota a pole -- uspořádaná posloupnost
položek. Formát zpráv není dopředu dán a podpora v~programovacích jazycích je
přímo integrovaná nebo dodaná pomocí knihovny. 

\subsection{GeoJSON}
GeoJSON \cite{GeoJSON} je, jak již název napovídá, nadstavba formátu JSON pro přenos
geografických informací. Z~hlediska syntaxe se jedná o~korektní JSON, který má
ale předepsanou strukturu a názvy položek. Umožňuje ukládat body, linie, plochy,
multipolygony a další objekty spolu s~jejich atributy a je nativně podporován
většinou JavaScriptových knihoven pro zobrazování mapových dat.

\subsection{XML}
XML \cite{XML} je značkovací formát používaný pro přenos strukturovaných dat
mezi aplikacemi. Jedná se o~textový formát, ve kterém jsou uložena strukturovaná
data ve formě entit uspořádaných do stromové struktury. Každá entita má jméno a
může mít parametry. 

\subsection{GPX}
Formát GPX \cite{GPX} je určen pro výměnu polohových dat mezi různými zařízeními s~GPS,
popřípadě mobilními a jinými aplikacemi. Data jsou uložena ve formátu XML, jsou
dělena na cesty, trasy a významné body. Každá cesta, trasa i významný bod může
mít uložené některé informace v~předdefinovaných atributech, případně libovolné
další informace uvnitř elementu {\tt <extensions>}. 

\subsection{Unixový čas}
Unixový čas je standardní způsob reprezentace data a času na Unixových
systémech. Je obvykle ukládán v~sekundách od půlnoci 1.\,1.\,1970 UTC.

\section{Systémy zeměpisných souřadnic}
Zeměpisné souřadnice jsou v~rámci práce používány ve dvou souřadnicových
systémech -- UTM a WGS84. Při klasifikaci dat z~OSM jsou jejich souřadnice
převedeny do UTM a tak jsou dále uchovávány. Při přípravě výsledků vyhledávání
jsou body na trasách převedeny zpět do WGS84 a takto jsou vráceny. Veškerá data
předávaná knihovně či vrácená knihovnou jsou ve WGS84.
\subsection{WGS84}
World Geodetic System 1984 (WGS84) \cite{WGS84} je geodetický standard
definující souřadnicový systém a referenční elipsoid pro popis polohy objektů na
povrchu Země. Využívá polárních souřadnic, zeměpisná šířka se určuje od rovníku,
zeměpisná délka od \uv{IERS Reference Meridian}. Výhodou je pokrytí celého
povrchu Země jedním systémem, vzhledem k~použití elipsoidu a polárních souřadnic
je obtížné počítat vzdálenosti mezi dvěma body.
\subsection{UTM}
Univerzální příčný Mercatorův systém souřadnic (UTM) \cite{UTM} je způsob
určování polohy na povrchu země založený na mřížkách. Povrch země je rozdělen na
60 zón a každá zóna je pak zobrazena pomocí příčného Mercatorova
zobrazení. Souřadnice v~rámci jedné zóny jsou pak udávány v~metrech, lze proto
snadno počítat vzdálenosti. Pozice bodu na Zemi se udává pomocí čísla zóny a
pozice uvnitř ní. Díky tomu, že UTM kvůli rozdělení na zóny zobrazuje vždy úzký
pás Země, nevzniká velké zkreslení vlivem válcového zobrazení. Praha a většina
dalších měst se také nenachází v~polárních oblastech, kde je zkreslení velké,
nebo se používá jiný systém souřadnic.


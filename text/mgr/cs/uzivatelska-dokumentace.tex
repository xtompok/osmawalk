\chapter{Uživatelská dokumentace}
\section{Příprava dat}
Pro přípravu dat je nejprve nutné nainstalovat potřebné externí knihovny (viz
soubor {\tt Install}) do
systému nebo do adresáře {\tt ext-lib}. Poté je nutné zkompilovat všechny zdrojové
kódy zavoláním {\tt make} v~adresáři {\tt compiled}. Dále je nutné vytvořit databáze
pro přípravu dat. Pro mapová data je potřeba vytvořit databázi {\tt
osmawalk-prepare},
pro jízdní řády je potřeba vytvořit databázi {\tt gtfs\_praha}. Pak je již možné
přistoupit k~samotné přípravě dat. Pokud je vše správně nastavené, stačí spustit
skript {\tt prepare.sh} v~kořenovém adresáři projektu a po několika hodinách
budou data připravena. Pokud skript selže, dále popíšeme činnosti, které skript
provádí, aby bylo možné jednotlivé fáze spouštět ručně a hledat, kde nastala chyba.

\begin{enumerate}
\item {\tt osm/prepare.sh} slouží ke stažení dat OSM, SRTM, spojení jednotlivých
dílů dat SRTM a tvorbu výřezu z~dat OSM. Výstupem je soubor {\tt osm/praha.osm}
s~výřezem z~dat OSM a soubor {\tt heights.bin} se spojenými daty SRTM pro daný
výřez. 
\item {\tt compiled/parse} slouží ke klasifikaci dat OSM, určení typů objektů,
určení vrcholů na mostech a pod zemí a přiřazení nadmořské výšky k~uzlům.
Výstupem jsou soubory {\tt data/nodes-stage1}, {\tt data/ways-stage1} a {\tt
data/mp-stage1} s~jednotlivými objekty. Formát uložení je popsán v~sekci Formáty
dat\ref{ch:formaty:priprava}. Nastavení klasifikátoru je v souboru {\tt
config/waytypes.yaml} pro cesty a {\tt config/nodetypes.yaml} pro body. Formát
konfiguračních souborů je popsán v bakalářské práci \cite{bakalarka}.
\item {\tt todb.sh} slouží k~nahrání klasifikovaných dat do databáze. 
\item {\tt postgis/process.sh} řídí úpravy dat v~databázi, uvnitř obsahuje
volání jednotlivých kroků popsaných v~kapitole \ref{ch:implementace}.
Výstupem jsou soubory {\tt data/\dots.csv} obsahující vrcholy a hrany dat
připravených pro vyhledávání. 
\item {\tt compiled/csvtograph} Vytváří vyhledávací graf a vybírá v~něm největší
souvislou komponentu, kterou uloží pro hledání jako soubor {\tt
data/postgis-graph.pbf}.
\end{enumerate}

Pro přípravu jízdních řádů stačí v adresáři {\tt ext-lib/mmpf/raptor} spustit
skript {\tt update-gtfs.sh}. Tento skript stáhne aktuální jízdní řády, nahraje
je do databáze a spustí skript {\tt prepare.py}, který připraví soubor {\tt
tt.bin} s jízdními řády. 

Při přípravě dat je potřeba vždy nejprve aktualizovat jízdní řády a pak teprve
aktualizovat mapu. Při přípravě mapových dat dochází i k párování zastávek MHD a
je proto potřeba již mít vygenerované soubory sloužící ke spojení obou datových
souborů.

\section{Konfigurační soubor}
Pro konfiguraci vyhledávání slouží soubor {\tt config/speeds.yaml}. Tento soubor
má formát YAML a skládá se z několika úrovní asociativních polí. Kořenové pole
obsahuje jako klíče jednotlivé kategorie, které jsou nastavovány a jako hodnoty
buď přímo nastavení, nebo další mapování uchovávající nastavení. Kategorie
nastavení jsou následující:
\begin{itemize}
	\item {\tt speeds} udává absolutní rychlosti pěších přesunů. Hodnotou je mapování
	typ cesty $\rightarrow$ rychlost v km/h.
	\item {\tt ratios} udává rychlosti pěších přesunů jako násobek rychlosti
	pohybu po cestě typu {\tt WAY}. Hodnotou je stejné mapování jako u {\tt
	speeds} V případě, že je definována rychlost obojím způsobem, má
	přednost absolutní rychlost před poměrnou.
	\item {\tt penalties} udává penaltu za jednotlivé druhy cest. Hodnotou
	je mapování typ cesty $\rightarrow$ penalta. Penalta se násobí počtem
	sekund strávených procházením hrany. 
	\item {\tt heights} udává koeficient délkového prodloužení v závislosti
	na změně výšky. Hodnotou je mapování s klíči {\tt upscale} a {\tt
	downscale}.  Pokud je cesta do kopce, je prodloužena o {\tt <rozdíl
	výšky>}$\times${\tt upscale} metrů, pokud je z kopce, o {\tt <rozdíl
	výšky>}$\times${\tt downscale}. Cesta může být i zkrácena, pokud by
	celková délka byla záporná, je uvažována jako nulová.
	\item {\tt pt-time-penalties} udává penalty za typ dopravního prostředku
	násobené dobou strávenou v dopravním prostředku v sekundách. Hodnotou je
	mapování typ prostředku $\rightarrow$ penalta, kde typ prostředku je brán
	z GTFS a psán malými písmeny, např. {\tt tram}, {\tt ferry} nebo {\tt
	bus}.
	\item {\tt pt-fixes-penalties} udává fixní penalty za typ dopravního
	prostředku. Počítá se pro každou cestu daným typem prostředku jednou
	nezávisle na délce cesty. Hodnotou je stejné mapování jako u {\tt
	pt-time-penalties}.
	\item {\tt line-penalties} udává penaltu za použití dané linky. Penalta
	se počítá jednou za každé použití dané linky. Hodnotou je mapování jméno
	linky $\rightarrow$ penalta. 
	\item {\tt max-vehicles} udává maximální počet spojů MHD použitých po
	cestě. Hodnotou je číslo udávající tento počet.
	\item {\tt geton-penalty} udává penaltu za nástup do spoje MHD. Je to
	fixní penalta za každý nástup. Hodnotou je číslo udávají penaltu.
	\item {\tt min-wait} udává minimální čas od příchodu /
	příjezdu na zastávku do odjezdu spoje. Hodnotou je čas v sekundách.
\end{itemize}
U kategorií, které udávají penaltu, lze místo čísla napsat {\tt inf}, což znamená
nekonečnou penaltu, tedy pokud nějaké částečná trasa dostane takovouto penaltu,
tak už se dále nepokračuje ve vyhledávání zbytku trasy.

\section{Konzolová aplikace}
Konzolová aplikace slouží převážně pro testování, zda vyhledávací knihovna
pracuje stabilně, ale dá se použít i pro jednoduché hledání. Aplikaci spustíme
v~adresáři compiled příkazem {\tt ./search <flat> <flon> <tlat> <tlon> [time]},
kde {\tt flat} a {\tt flon} určují zeměpisnou šířku a délku výchozího bodu, {\tt
tlat} a {\tt tlon} souřadnice cílového bodu a {\tt time} unixový timestamp času,
od kterého hledat. Pokud není čas uveden, hledá se od
okamžiku spuštění.  Aplikace najde trasy a na standardní výstup vypíše ke každé
trase použité spoje MHD. Navíc v~aktuálním adresáři vytvoří soubor {\tt
track.gpx}, který obsahuje jednotlivé nalezené trasy.
 
\section{Webová aplikace}
Webovou aplikaci je možné vyzkoušet na \url{http://mhd.bezva.org} nebo si ji spustit lokálně
pomocí příkazu {\tt python wsgi.py} v~adresáři {\tt webapp}. V~případě, že knihovna
{\tt libraptor.so} není umístěná tam, kde systém hledá sdílené knihovny, je potřeba ji
do této cesty buď přesunout, nebo zavolat příkaz {\tt export
LD\_LIBRARY\_PATH=<cesta k~libraptor.so>}. Po spuštění aplikace je možné si
otevřít prohlížeč na stránce, která se vypíše během spouštění aplikace.
I~v~případě, že spouštíme aplikaci lokálně, je potřeba mít k~dispozici připojení
k~internetu, protože mapové podklady a javascriptové knihovny se načítají ze
serverů třetích stran.

Po otevření webové aplikace je zobrazené hlavní okno s~mapou. Interakce s~mapou,
kromě základního posouvání a zvětšování, probíhá kliknutím na bod. Prvním
kliknutím je zvolen výchozí bod, ze kterého hledat, druhým kliknutím je zvolen
cílový bod do kterého se hledá trasa. Volbou cílového bodu je odeslán požadavek
na vyhledání trasy. Po vyhledání jsou v~levém sloupci zobrazená shrnutí
jednotlivých nalezených tras v~pořadí podle času příjezdu do cíle a první trasa
je zobrazena v~mapě. Zobrazení nebo skrytí jednotlivých tras se provede
kliknutím na její souhrn v~levém sloupci. Jednotlivé části trasy jsou obarveny
podle typů hran, po kterých vedou a dále jsou zvýrazněna místa přestupu na MHD.
Detailní informace o~MHD lze zobrazit kliknutím na ikonu u~přestupní zastávky
nebo na hranu spoje MHD. Trasy lze exportovat do GPX kliknutím na tlačítko
\uv{Stáhnout jako GPX} v hlavičce stránky.

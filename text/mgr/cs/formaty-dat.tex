\chapter{Formáty dat}
V rámci přípravy dat a vyhledávání tras jednak používáme interní struktury
jednotlivých programovacích jazyků, jednak některé standardní formáty nezávislé
na programovacím jazyku. Tyto formáty ppředstvíme v následující sekci, v dalších
sekcích se již jen budeme věnovat obsahu jednotlivých struktur.
\section{Používané formáty dat}
\subsection{Protocol Buffers}
Protocol Buffers (PBF) je způsob uložení strukturovaných dat. Byl navržen
Googlem a je používán v případech, kdy potřebujeme přenést po síti zprávy s
danou strukturou. Formát podoporuje různé datové typy (integer různých přesností
a znaménkovosti, čísla s plovoucí řádovou čárkou, stringy, \dots) a
strukturování zpráv. Komunikace probíhá ve fázích naplnění zprávy, její
zabalení, odeslání, přijmutí a rozbalení. Při zabalení jsou data zkompirmována
jednoduchým algoritmem, aby například malá čísla nezabírala zbytečně mnoho
místa. Existují PBF verze 2 a verze 3. V naší práci používáme verzi 2, protože v
době psaní bakalářské práce, kterou v naší práci rozšiřujeme, nebyly PBF verze 3
ještě k dispozici a verze 3 nepřináší novinky, které by motivovaly k přechodu.

Základní jednotkou PBF je zpráva, která obsahuje několik položek. Položkou může
být základní datový typ nebo jiná zpráva, položky mohou být povinné, volitelné,
nebo opakované. Každá položka má jméno, typ a číslo, které ho identifikuje v
binární podobě zprávy. Zprávy se popisují pomocí vlastního jazyka, ze kterého se
pak pomocí kompilátoru vytvoří vazby do jednotlivých programovacích jazyků. 
Podrobnou dokumentaci včetně tutoriálů lze najít na stránkách projektu (\TODO
ref).

\subsection{JavaScript Object Notation}
JavaScript Object Notation(\TODO ref) (JSON) je formát navržený pro předávání dat ve
webových aplikacích. Díky své jednoduchosti a čitelné reprezentaci je hojně
využíván nejen ve webových projektech, ale často i jako konfigurační jazyk.
Vychází z Javascriptu, datové typy v něm jsou kromě primitivních typů slovník --
neuspořádaný seznam dvojic klíč--hodnota a pole -- uspořádaná posloupnost
položek. Formát zpráv není dopředu dán a podpora v programovacích jazycích je
přímo integrovaná nebo dodaná pomocí knihovny. 

\subsection{GeoJSON}
GeoJSON(\TODO ref) je, jak již název napovídá, nadstavba formátu JSON pro přenos
geografických informací. Z hlediska syntaxe se jedná o korektní JSON, který má
ale předepsanou strukturu a názvy položek. Umožňuje ukládat body, linie, plochy,
multipolygony a další objekty spolu s jejich atributy a je nativně podporován
většinou JavaScriptových knihoven pro zobrazování mapových dat.

\subsection{GPX}
Formát GPX(\TODO ref) je určen pro výměnu polohových dat mezi různými zařízeními s GPS,
popřípadě mobilními a jinými aplikacemi. Data jsou uložena ve formátu XML, jsou
dělena na cesty, trasy a významné body. Každá cesta, trasa i významný bod může
mít uložené některé informace v předdefinovaných atributech, případně libovolné
další informace uvnitř tagu {\tt <extensions>}. 

\section{Formáty používané při přípravě dat}
\TODO PBF
\section{Formáty používané při vyhledávání tras}
\subsection{Formát jízdních řádů}
Jízdní řády jsou po zpracování uloženy ve zprávě {\tt Timetable}. Způsob
provázání dat v jednotlivých položkách je popsán v kapitole Implementace (\TODO
ref). Zpráva má následující položky:
\TODO zjistit, zda v popisu implementace je způsob ukládání dat
\begin{itemize}
	\item {\tt routes} obsahuje popis linek
	\item {\tt stop\_times} obsahuje časy zastavení spojů 
	\item {\tt trip\_validity} obsahuje pro každý spoj index na platnost 
	\item {\tt validities} platnost -- obsahuje popis, které dny nějaký spoj
	jede a které ne 
	\item {\tt route\_stops} udává, která linka má jaké zastávky 
	\item {\tt stops} obsahuje popis zastávek
	\item {\tt transfers} obsahuje popis pěších přestupů, v práci není
	používá 
	\item {\tt stop\_routes} udává, které linky jedou přes jakou zastávku
\end{itemize} 
Každá linka je reprezentována zprávou typu {\tt Route} s následujícími
položkami:
\begin{itemize}
	\item {\tt id} udává RAPTOR id linky 
	\item {\tt nstops} udává počet zastávke linky
	\item {\tt ntrips} udává počet spojů linky
	\item {\tt stopsidx} udává index do pole {\tt route\_stops}, kde
	začínají zastávky linky
	\item {\tt tripsidx} udává index do pole {\tt stop\_times}, kde
	začínají časy spojů linky
	\item {\tt servicesidx} udává index do pole {\tt trip\_validities}, kde
	začínají platnosti spojů linky
	\item {\tt name} udává název linky
	\item {\tt type} udává typ dopravního prostředku
\end{itemize}
Každá zastávka je reprezentována zprávou typu {\tt Stop} s následujícími
položkami:
\begin{itemize}
	\item {\tt id} udává RAPTOR id zastávky
	\item {\tt nroutes} udává počet linek projíždějících zastávkou
	\item {\tt ntransfers} udává počet pěších přestupů ze zastávky
	-\item {\tt routeidx} udává index do pole {\tt stop\_routes}, kde
	začínají linky dané zastávky
	\item {\tt transferidx} udává index do pole {\tt transfers}, kde
	začínají přestupy ze zastávky
	\item {\tt name} udává jméno zastávky
	\item {\tt underground} udává, zda je zastávka v podzemí
\end{itemize}
Každé zastavení spoje je reprezentováno zprávou typu {\tt StopTime} s
následujícími položkami:
\begin{itemize}
	\item {\tt arrival} udává čas příjezdu do zastávky
	\item {\tt departure} udává čas odjezdu ze zastávky
\end{itemize}
Každá množina dní, kdy některý spoj jede, je reprezentována pomocí zprávy typu
{\tt Validity}, která má následující položky:
\begin{itemize}
	\item {\tt start} udává UNIX timestamp prvního dne platnosti 
	\item {\tt end} udává UNIX timestamp posledního dne platnosti
	\item {\tt bitmap} udává bitmapu platnosti počínaje prvním dnem
	platnosti. Každý den odpovídá jednomu bitu.
\end{itemize}
Pokud bychom měli nějaké pěší přestupy, byly by reprezentovány zprávou typu {\tt
Transfer} s následujícími položkami:
\begin{itemize}
	\item {\tt from} udává počáteční zastávku
	\item {\tt to} udává koncovou zastávku
	\item {\tt time} udává čas potřebný pro přesun mezi zastávkami
\end{itemize}
\subsection{Jízdní řád pro konkrétní den}
Pro samotné vyhledávání si vždy nejprve připravíme jízdní řád pro tento
konkrétní den. Jízdní řád je reprezentován strukturou {\tt timetable} v C s následujícími
položkami:
\begin{itemize}
	\item {\tt nroutes} udává počet linek
	\item {\tt routes} obsahuje popis linek
	\item {\tt st\_times} obsahuje popis zastavení spojů v zastávkách
	\item {\tt transfers} obsahuje popis pěších přestupů
	\item {\tt nstops} udává počet zastávek
	\item {\tt stops} obsahuje popis zastávek
	\item {\tt rt\_stops} obsahuje odkazy na zastávky pro linky 
	\item {\tt st\_routes} obsahuje odkazy na linky pro zastávky
\end{itemize}
Každá linka je popsána strukturou {\tt route} s následujícími položkami:
\begin{itemize}
	\item {\tt pbroute} odkazuje na linku v původním jízdním řádu
	\item {\tt nstops} udává počet zastávek linky
	\item {\tt ntrips} udává počet spojů linky
	\item {\tt stops} odkazuje na začátek odkazů na zastávky dané linky
	\item {\tt trips} odkazuje na začátek zastavení spojů linky v zastávkách 
	\item {\tt name} udává jméno linky
\end{itemize}
Každé zastavení spoje v zastávce je popsáno strukuturou {\tt st\_time}
\begin{itemize}
	\item {\tt arrival} udává čas příjezdu spoje do zastávky
	\item {\tt departure} udává čas odjezdu spoje ze zastávky
\end{itemize}
Každá zastávka je popsána strukturou {\tt stop} s následujícími položkami
\begin{itemize}
	\item {\tt pbstop} odkazuje na zastávku v původním jízdním řádu
	\item {\tt nroutes} udává počet linek projíždějících zastávkou daný den
	\item {\tt ntransfers} udává počet pěších přestupů z dané zastávky
	\item {\tt routes} odkazuje na začátek odkazů na linky projíždějící
	zastávkou 
	\item {\tt transfers} odkazuje na začátek pěších přestupů pro danou
	zastávku
	\item {\tt name} udává název zastávky
\end{itemize}
Každý pěší přestup mezi zastávkami je popsán strukturou {\tt transfer}. Tato
struktura není v současné době využívána. Má tyto položky: (\TODO opravit
implementaci)
\begin{itemize}
	\item {\tt from} odkazuje na výchozí zastávku
	\item {\tt to} odkazuje na cílovou zastávku
	\item {\tt time} udává čas v sekundách potřebný na přestup z výchozí do
	cílové zastávky
\end{itemize}
\subsection{Vyhledávací graf}
Vyhledávací graf je uložen v PBF ve zprávě {\tt Graph}, která obsahuje tyto
položky:
\begin{itemize}
	\item {\tt vertices} obsahuje popis vrcholů grafu
	\item {\tt edges} obsahuje popis hran grafu
	\item {\tt stops} obsahuje popis vazeb mezi zastávkami a vrcholy grafu 
\end{itemize} 
Každý vrchol je popsán pomocí zprávy {\tt Vertex}, která obsahuje následující
položky:
\begin{itemize}
	\item {\tt idx} udává číslo vrcholu
	\item {\tt osmid} udává OSM id vrcholu
	\item {\tt lat} a {\tt lon} udávají zeměpisnou šířku a délku vrcholu v
	UTM
	\item {\tt type} udává typ vrcholu
	\item {\tt height} udává nadmořskou výšku vrcholu
	\item {\tt stop\_id} pokud je vrchol zastávka, pak udává GTFS id
	zastávky (\TODO ověřit) 
\end{itemize} 
Každá hrana je popsána pomocí zprávy {\tt Edge}, která obsahuje následující
položky: 
\begin{itemize}
	\item {\tt idx} udává číslo hrany
	\item {\tt osmid} udává OSM id hrany
	\item {\tt vfrom} udává číslo výchozího vrcholu 
	\item {\tt vto} udává číslo cílového vrcholu
	\item {\tt type} udává typ hrany
	\item {\tt crossing} má udávat typ cesty, kterou hrana kříží, nepoužívá
	se
	\item {\tt dist} udává délku hrany
\end{itemize} 
Každá zastávka je popsána pomocí zprávy {\tt Stop}, která obsahuje následující
položky:
\begin{itemize}
	\item {\tt idx} udává číslo zastávkového vrcholu
	\item {\tt osmid} udává OSM id zastávkového vrcholu 
	\item {\tt raptor\_id} udává pořadí zastávky v algoritmu RAPTOR
	\item {\tt stop\_id} udává id zastávky v GTFS
\end{itemize} 

\subsection{Struktury používané při hledání trasy}
Pro samotné hledání potřebujeme haldu, kterou budeme používat pro Dijkstrův
algoritmus. Halda je implementována pomocí struktury {\tt mmqueue\_t}, která
obsahuje následující položky:
\begin{itemize}
	\item {\tt pool} odkazuje na memory pool pro alokaci nových vrcholů
	vkládaných do fronty 
	\item {\tt graph} odkazuje na vyhledávací graf popsaný výše
	\item {\tt vert} odkazuje na aktuální vrchol 
	\item {\tt vertlut} obsahuje pro každý vrchol grafu pole odkazů na
	vrcholy v haldě, které patří k danému vrcholu
	\item {\tt heap} obsahuje odkazy na jednotlivé vrcholy v haldě
	\item {\tt n\_heap} udává počet vrcholů v haldě
\end{itemize}
Každý vrchol v haldě je popsán pomocí struktury {\tt mmdijnode\_t}, která
obsahuje následující položky:
\begin{itemize}
	\item {\tt prev} odkazuje na předchozí vrchol na trase
	\item {\tt osmvert} pokud je vrchol z OSM, odkazuje na vrchol ve
	vyhledávacím grafu 
	\item {\tt stop} pokud je vrchol zastávka, odkazuje na zastávku v
	jízdním řádu pro celou platnost
	\item {\tt edge} popisuje hranu, která vede do zpracovávaného vrcholu 
	\item {\tt reached} indikuje, zda již byl vrchol dosažen
	\item {\tt completed} indikuje, zda již byl vrchol uzavřen
	\item {\tt majorized} indikuje, zda při přidávání jiných vrcholů byl
	tento vrchol majorizován
	\item {\tt arrival} udává čas příjezdu do vrcholu
	\item {\tt penalty} udává penaltu při příchodu do vrcholu \TODO ověřit
\end{itemize}
Protože přicházející hrana může být jak hranou z OSM, tak hranou MHD, je
reprezentována pomocí struktury {\tt edge\_t}, která obsahuje následující
položky:
\begin{itemize}
	\item {\tt edge\_type} udává typ hrany ({\tt EDGE\_TYPE\_WALK} nebo {\tt
	EDGE\_TYPE\_PT}
	\item union {\tt osmedge} a {\tt ptedge} odkazuje buď na konkrétní hranu
	ve vyhledávacím grafu, nebo na popis hrany MHD 
\end{itemize}
Hrany pomocí MHD jsou popsány strukturou {\tt ptedge\_t}, která obsahuje
následující položky: 
\begin{itemize}
	\item {\tt departure} udává čas odjezdu z výchozí zastávky v sekundách
	od začátku dne jízdního řádu
	\item {\tt route} odkazuje na linku v jízdním řádu
\end{itemize}

Pro reprezentaci nalezených spojení MHD z dané zastávky slouží struktura {\tt
stop\_conns}, která má následující položky:
\begin{itemize}
	\item {\tt n\_routes} udává počet linek jedoucích z dané zastávky
	\item {\tt routes} popisuje linky jedoucí z dané zastávky
\end{itemize}
Každá linka je popsána pomocí struktury {\tt stop\_route, která obsahuje
následující položky} 
\begin{itemize}
	\item {\tt departure} udává čas odjezdu linky ze zastávky, v sekundách
	od počátku dne jízdního řádu 
	\item {\tt pbroute} odkazuje na linku v původním jízdním řádu
	\item {\tt n\_stops} udává počet zastávek na dané lince směrem na
	konečnou
	\item {\tt stops} popisuje jednotlivá zastavení na lince
\end{itemize}
Jednotlivá zastavení spoje v zastávkách po cestě jsou popsána pomocí struktury
{\tt stop\_arr}, která obsahuje následující položky:
\begin{itemize}
	\item {\tt to} odkazuje na zastávku, kde spoj stojí
	\item {\tt arrival} udává čas příjezdu \TODO v jakém formátu
\end{itemize}
 
\TODO jaké jsou další struktury pro hledání

\subsection{Výsledky vyhledávání}
Výsledky vyhledávání jsou z knihovny předávány jako zabalená zpráva PBF. Zpráva
obsahuje pouze jednu opakovanou položku typu {\tt Route}, která obsahuje všechny
nalezené trasy. Každá trasa pak má následující položky: 
\begin{itemize}
	\item {\tt time} udává čas příjezdu do cílového bodu
	\item {\tt dist} udává celkovou délku pěších přechodů na trase
	\item {\tt penalty} udává penaltu trasy
	\item {\tt point} obsahuje jednotlivé body trasy
\end{itemize}
Jednotlivé body trasy jsou spolu s hranou, která do nich vede, popsány zprávou
{\tt Point} s následujícími položkami: 
\begin{itemize}
	\item {\tt lat} a {\tt lon} udávají zeměpisnou šířku a délku bodu v
	systému WGS-84
	\item {\tt height} udává nadmořskou výšku bodu
	\item {\tt departure} pokud je hrana MHD, pak udává čas odjezdu z místa
	nástupu
	\item {\tt arrival} udává čas příchodu/příjezdu do bodu 
	\item {\tt osmvert} pokud je bod z OSM, pak obsahuje informace o vrcholu
	z OSM, je to zpráva typu {\tt graph.Vertex}, která je popsána výše
	\item {\tt stop} pokud je bod zastávka, pak obsahuje informace o vrcholu z GTFS
	\item {\tt edgetype} udává, zda jde o pěší hranu, nebo přesun MHD
	\item {\tt walkedge} pokud je hrana chůze, pak obsahuje informace o
	hraně z OSM, je to zpráva typu {\tt graph.Edge}, která je popsána výše
	\item {\tt ptedge} pokud je hrana MHD, pak obsahuje informace o hraně z
	GTFS.
\end{itemize}
Informace o zastávce jsou uloženy ve zprávě {\tt Stop}, která má následující
položky:
\begin{itemize}
	\item {\tt name} udává název zastávky
	\item {\tt id} udává kód zastávky tak, jak je v GTFS
\end{itemize}
Informace o hraně využívající MHD jsou uloženy ve zprávě {\tt PTEdge}, která
obsahuje následující položky:
\begin{itemize}
	\item {\tt name} udává název linky
	\item {\tt id} udává id linky tak, jak je v GTFS
\end{itemize}
Uvnitř vyhledávací knihovny je výsledek vyhledávání reprezentován typem {\tt
search\_result\_t}, který je svou strukturou velmi podobný výše popsanému PBF.

Vyhledané trasy je možné uložit do formátu GPX (\TODO ref). V naší aplikaci používáme pouze trasy, každá
nalezená vyhledaná trasa odpovídá jedné trase v GPX, tato trasa je rozdělena na
pěší segmenty a segmenty MHD. Typ segmentu je uložen u každého segmentu v sekci
{\tt <extensions>} v tagu {\tt <type>}. Každá trasa má ve své sekci {\tt
<extensions>} uložený čas příjezdu, pěší vzdálenost a penaltu postupně v tazích
{\tt <arrival>}, {\tt <len>} a {\tt <penalty>}.

\section{Formáty používané ve webové aplikaci}
\subsection{Výsledky vyhledávání}
Výsledky vyhledávání jsou předávány z backendu do frontendu webové aplikace
(\TODO ref webová aplikace) pomocí formátu JSON. Ten je tvořen polem vyhledaných
tras, kde každá trasa je slovník s následujícími klíči:
\begin{itemize}
	\item {\tt time} udávající čas příjezdu do cíle
	\item {\tt dist} udávající celkovou pěší vzdálenost na nalezené trase
	\item {\tt penalty} udávající penaltu vyhledané trasy
	\item {\tt geojson} obsahující grafickou reprezentaci nalezené trasy. 
\end{itemize}
Grafická reprezentace nalezené trasy je reprezentována ve formátu GeoJSON a
obsahuje lomené linie jednotlivých typů popisující průběh cesty a bodové prvky
pro nástup a výstup z prostředku MHD.

Liniové prvky jsou reprezentovány typem LineString, více sousedících hran
stejného typu je vždy spojeno v jeden úsek typu LineString. Hrany reprezentující různé
spoje MHD se do jednoho úseku nespojují. Úseky mají následující atributy: 
\begin{itemize}
	\item {\tt type} udávající typ úseku (dle číslování objtype)
	\item {\tt name} udávající jméno linky, atribut je přítomen pouze, pokud
	jde o úsek typu MHD
\end{itemize}
Bodové prvky jsou reprezentovány pomocí typu Point s následujícími atributy: 
\begin{itemize}
	\item {\tt type} udávající typ bodu, zde vždy číslo reprezentující objtype PUBLIC\_TRANSPORT  	
	\item {\tt name} udávající jméno zastávky
	\item {\tt subtype} udávající operaci na zastávce ({\tt departure} pro
	nástup, {\tt arrival} pro výstup)
	\item {\tt departure} čas odjezdu spoje ze zastávky
	\item {\tt arrival} pro nástupní bod čas příchodu na zastávku, pro
	výstupní bod čas příjezdu do zastávky
\end{itemize}
\TODO příklad

\chapter{Předzpracování dat}


\section{Příprava mapových dat}
Nejprve jsou stažena aktuální data pro Českou republiku, která jsou k dispozici
s denními aktualizacemi (\TODO url). Z těchto dat je na základě nastavení
vyříznut obdélník, který pokrývá zpracovávanou oblast. Poté začneme data
zpracovávat.

Nejprve jsou klasifikovány jednotlivé objekty. Klasifikují se uzly, hrany a
multipolygony, jiné typy relací nejsou v současné době používány. Každý objekt
je klasifikován nějakým typem podle toho, jaké má tagy. V rámci konfigurace lze
přidělit nějakému tagu (buď samotnému klíči, nebo dvojici klíč-hodnota) určený
typ s danou prioritou. Objekt bude mít typ daný pravidlem s nejvyšší prioritou,
které jeho tagy splňují. Pokud objekt nesplňuje žádné pravidlo, získá speciální
typ označující neklasifikovaný objekt.V dalším zpracování se již nehledí na
původní tagy ale jen na typ, který daný objekt má.

Současně s klasifikací typu objektu se stejným způsobem určují hrany, které se
nachází na mostech a uzly, které jsou v podzemí. Klasifikovaná data nahrajeme do
databáze a další kroky provádíme jako databázové operace. 

\subsection{Dělení dlouhých linií}
Protože chceme hledat co nejblíže od výchozího zadaného bodu, v případě dlouhých
rovných ulic, které jsou reprezentovány pomocí lomených linií s dlouhými úseky
by se nám mohlo stát, že by nejbližší bod od hledaného místa neležel na ulici,
kde jsme, ale na nějaké sousední, od které nás dělí pás budov. Proto dlouhé
úseky cest rozdělíme na menší podúseky, čímž tento problém eliminujeme.
Rozdělení se nám také bude hodit pro vytváření zkratek, o kterých pojednáváme
níže.

\subsection{Překážky}
Pro další zpracování potřebujeme znát nejen cestní síť, ale i překážky, přes
které se nedá projít, jako jsou například domy, ploty a dálnice. V tomto místě
se musíme vypořádat s multipolygony. Protože multipolygony, které klasifikujeme
jako bariéry, jsou z velké části budovy, která má více částí nebo má nádvoří,
nebo jiné překážky, uvnitř kterých se neočekává, že by byla velká plocha, bereme
jako překážku jejich vnější obrys, případně obrysy. To nám sice způsobí, že
nebudeme moci vytvářet na vnitřních prostranstvích zkratky, ale to nám nevadí,
protože jednak mají vnitřní prostranství obvykle velmi malou plochu a nevede do
nich mnoho pěších cest, jednak vnitřní prostranství jsou buď zmapována
kompletně, nebo nedostatečně, tudíž by případné vytváření zkratek ve vnitřním
prostranství vedlo k cestám, které by ve skutečnosti nebyly možné.

Výsledná množina překážek bude obsahovat vnější obrysy multipolygonů, další
polygonové objekty a liniové objekty.

\subsection{Body uvnitř objektů a body pod zemí}
Abychom mohli generovat zkratky, které budou průchozí i ve skutečnosti, je
potřeba určit, které body se nachází na volném prostranství na povrchu a které
se nacházejí pod zemí. Podzemní vrcholy jsme určili už v rámci klasifikace.
Vrcholy uvnitř objektů jsme ztotožnili s vrcholy, které se nachází uvnitř nějaké
překážky, protože překážky jsou pro nás takové objekty, přes které se nedá pěšky
projít napříč. Body, které se nacházejí na plášti překážky, jako vnitřní
neuvažujeme, protože se z nich dá jít libovolným směrem, kde se nenachází
překážka.

\subsection{Zkratky}
Pro doplnění chybějících vazeb v mapě používáme kromě cest v mapových datech
již obsažených i automaticky generované zkratky. Zkratka spojuje dva pochozí
body na volném prostranství, které jsou nedaleko od sebe a úsečka mezi nimi,
reprezentující zkratku, neprotíná žádnou překážku. Dvojic bodů, které splňují
zadané podmínky, je ale velké množství a přidání všech zkratek by neúměrně
zvyšovalo velikost výsledných dat. Od počtu zkratek z daného vrcholu přidávání
dalších zkratek má jen malý vliv na délky hledaných cest, proto jsou ze všech
možných zkratek náhodně vybrány jen některé a to tak, aby z každého vrcholu
vycházelo průměrně omezené množství zkratek. Takto zachováme pozitivní vliv
zkratek na hledané cesty, ale zbytečně nezvětšujeme vyhledávací graf.

\section{Příprava jízdních řádů}
Data z jízdních řádů dostáváme ve formátu GTFS (\TODO ref GTFS) a musíme je
upravit do formátu vhodného pro algoritmus RAPTOR (\TODO ref RAPTOR). Samotný
formát GTFS je již poměrně blízký cílovému formátu, ale je potřeba vyřešit
několik drobností. \TODO přepsat

\subsection{ID zastávek}
Zastávky mají dle specifikace GTFS jako ID použit obecný string. Data pro
pražskou MHD mají toto ID rozdělené na na část reprezentující zastávku a část
reprezentující konkrétní zastávkové stojany. Pro další zpracování je vhodné
zvolit číselný identifikátor, jednotlivé zastávky jsou očíslovány čísly od 0 do
počet zastávek - 1 a veškeré odkazy na konkrétní zastávky ve zpracovaných datech
používají právě tato čísla. Původní identifikátor je u zastávky stále uložen
kvůli následnému párování (viz níže), ale již se pro vazbu mezi daty nepoužívá.
\TODO: co z toho do implementace?

\subsection{Platnost jízdního řádu}

\subsection{Rozdělení linek}

\subsection{Podzemní stanice}


\section{Párování zdrojových dat}
Abychom moli plánovat spojení využívající jak pěší chůzi, tak jízdu MHD, je
potřeba data z obou zdrojů vhodně provázat. Máme k dispozici následující údaje:
\begin{enumerate}
\item OSM
\begin{itemize}
	\item jméno zastávky
	\item pozici zastávky
	\item ID zastávky (jen u některých)
\end{itemize}
\item GTFS
\begin{itemize}
	\item jméno zastávky
	\item pozici zastávky
	\item ID zastávky
\end{itemize}
\end{enumerate} 
V ideální připadě by bylo možné spárovat zastávky jednoduše dle ID, bohužel v
OSM má ID jen několik zastávek, většinu zastávek je tedy potřeba spárovat jinak.
Nabízelo by se párování podle pozic a jmen zastávek, ale bohužel zastávky v GTFS
jsou výrazně posunuté oproti OSM i skutečnosti, navíc ne všechny zastávkové
stojany jsou v OSM vyznačeny, zvláště tam, kde je několik zastávkových stojanů
za sebou, například v autobusových terminálech. Pokoušet se párovat zastávky v
GTFS pouze na zastávky v OSM by bylo velmi náročné s nejistým výsledkem.
Využíváme proto toho, že v OSM máme zmapované nejen zastávky, ale i cesty a
zastávkám v GTFS vytváříme speciální vrcholy dle jejich zeměpisné pozice v GTFS
a pomocí zkratek (viz dále \TODO ref) je spojujeme s nejbližšími cestami.

Pro zastávky z GTFS, pro které máme v OSM odpovídající ID, použijeme polohu z
OSM a zkratky k cestní síti hledáme z této polohy. Zkratky jsou i zde potřeba,
protože dle pravidel OSM (\TODO ref) se zastávka umisťuje na místo, kde zastavuje
vozidlo, což například u tramvají je bod na kolejích, které ale pro pěší
plánování nepoužíváme, tudíž je potřeba najít vhodný blízký bod v cestní síti.

Zvláštní pozornost je potřeba věnovat u párování zastávek metra. V současné
chvíli je metro v Praze zmapované dvěma způsoby. První způsob je novější a
přesnější, jsou při něm zmapována nástupiště a eskalátorové tunely. Při tomto
podrobném mapování jsou také přidána ID stanic, tudíž je možné stanice jednoduše
spárovat a hledat cestu od hrany nástupiště. Častějším způsobem je ale starší
způsob, kdy je stanice metra pouze bod, od kterého vede eskalátorový tunel na
povrch. Tento eskalátorový tunel je pouze virtuální spojka, neodpovídá reálné
poloze podzemních tras. Takovéto stanice rovněž nemají přiřazená ID. U těchto
stanic používáme polohu z GTFS a zkratky spojující zastávku s cestní sítí
hledáme do blízkých míst, která jsou v podzemí, což vede k poměrně dobré
aproximaci přístupu do metra. Jak bude postupovat mapování stanic metra, bude
tento typ stanic postupně eliminován a dojde ke zpřesnění navigace při
přestupech.

Z hlediska implementace jsou vždy preferovány zastávky a stanice zmapované
přesněji, které mají ID, stačí tedy vylepšovat mapu a při dalším předzpracování
dat se nově zmapované zastávky dostanou i do vyhledávače.

\section{Příprava společných vyhledávacích dat}
    - generovani spojek
